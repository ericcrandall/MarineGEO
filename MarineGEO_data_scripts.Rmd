---
title: "MarineGEO Data Formatting"
author: "Eric D. Crandall"
date: "5/29/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(plyr)
library(dplyr)
library(ggmap)
library(readxl)
library(lubridate)
filedir<-"~/google_drive/MarineGEO"

bbox<-c(left=-157.85,bottom= 21.38,right=-157.75, top=21.55)
dmap <- get_map(location = bbox, maptype = "satellite", source = "google")

```

# Fish

## Import and Format

### Import
```{r Fish_import}
# First go through and make sure all stations have Lat/Longs, or as many as possible
#read in the sample data, skipping first 3 lines of other headers. Format all times as hh:mm in Excel, paste into textwrangler if they need homogenization (i.e. multiple formats of times)

fish_samples<-read_excel(path="/Users/eric/google_drive/MarineGEO/Fish/KANEOHOE_SI_FIMS_20170714.xlsx",sheet="Specimen information",skip=3)

fish_events<-read_excel(path="/Users/eric/google_drive/MarineGEO/Fish/KANEOHOE_SI_FIMS_20170714.xlsx",sheet="Locality information",skip=3)

#remove columns without mapped DwC terms mapped
fish_samples<-fish_samples[,-grep(pattern = "^X",x = names(fish_samples),perl=T)]
fish_events<-fish_events[,-grep(pattern = "^X",x = names(fish_events),perl=T)]

#remove records without occurrenceIDs (temp before final dataset)
fish_samples<-fish_samples[-which(is.na(fish_samples$occurrenceID)),]
#translate fieldIDs to eventIDs
fish_samples$eventID<-gsub("LRP 17-","KANF0",fish_samples$eventID)

#use ddply to lump all materialSampleIDs into a single field, separated by a |
fish_samples<-ddply(fish_samples, "occurrenceID", transform, materialSampleID = paste(materialSampleID, collapse = "|"))

#keep only the first instance of each occurrenceID
fish_samples<-fish_samples1[!duplicated(fish_samples1$occurrenceID),]
```

### Format events to schema

```{r format events}
fish_events$decimalLatitude<-round(as.numeric(fish_events$decimalLatitude),digits = 4)
fish_events$decimalLongitude<-round(as.numeric(fish_events$decimalLongitude),digits = 4)
fish_events$georeferenceProtocol[which(fish_events$georeferenceProtocol=="GoogleEarth")]<-"Google Earth" ##Ask Diane to fill this in.
class(fish_events$coordinateUncertaintyInMeters) # ask Diane to fill this in.
fish_events$eventDate<-dmy(fish_events$eventDate) # make sure this imports correctly
class(fish_events$maximumDepthInMeters) #some missing. ask Diane to fill this in
class(fish_events$minimumDepthInMeters)#some missing. ask Diane to fill this in
class(fish_events$recordedBy) #some missing. ask Diane to fill this in
class(fish_events$samplingProtocol) #some missing. ask Diane to fill this in
class(fish_events$habitat) #needs to be formatted according to schema - Geomorph zone, substrate, biotic
fish_events$year<-year(fish_events$eventDate)
fish_events$month<-month(fish_events$eventDate)
fish_events$day<-day(fish_events$eventDate)

#Recommended fields
class(fish_events$eventRemarks)
class(fish_events$locality)
class(fish_events$eventTime)
class(fish_events$eventRemarks)
class(fish_events$eventRemarks)
class(fish_events$verbatimCoordinates)
class(fish_events$eventMedia)
```
### Format samples to schema

```{r format samples}

class(fish_samples$occurrenceID)
class(fish_samples$basisOfRecord)
class(fish_samples$eventID)
class(fish_samples$scientificName) #eventually parse this into taxon categories?
class(fish_samples$taxonRank) #using this
class(fish_samples$identifiedBy)
class(fish_samples$individualCount)
class(fish_samples$institutionID)
fish_samples$organismScope<-"organism"


```

### Join the event data onto the occurrence data

```{r}
fish<-left_join(fish_samples1,fish_events,by="eventID")
```

## Make a Map

```{r Fish_maps}
#optionally make it from the points provided
#bbox<-make_bbox(lon=fish2$decimalLongitude,lat=fish2$decimalLatitude)
#by individual
fish2<-fish %>% group_by(decimalLatitude, decimalLongitude) %>% summarize(count=n()) 

#by species
fish3 <- fish %>% group_by(scientificName, decimalLatitude, decimalLongitude) %>% summarize(count=n())

#richness
fish4<-fish3 %>% group_by(decimalLatitude,decimalLongitude) %>% summarize(richness=n())

fish6<-left_join(fish2,fish4)


ggmap(dmap) + geom_point(data = fish6, mapping = aes(x = decimalLongitude, y = decimalLatitude, size=count, color=richness)) + scale_color_gradient(low = "green", high="red") + guides(color=guide_colorbar(title="Species Richness",), size=guide_legend(title="Individual Count")) + theme(axis.title=element_blank())




```
# Algae

## Import and Format

### Import
```{r Algae_import}
#Add in KANI and KANM stations to events, edit eventIDs for capitalization

algae_samples<-read_excel("/Users/eric/google_drive/MarineGEO/algae/MarineGEOHI_bioassessment_master_KANA.xlsx", sheet="Sample")

algae_events<-read_excel("/Users/eric/google_drive/MarineGEO/algae/MarineGEOHI_bioassessment_master_KANA.xlsx", sheet="Station")
```

### Format events to schema

```{r Format events}
#round to 4 decimal digits (~10m uncertainty) and meake sure longitude is negative
algae_events$decimalLatitude<-round(as.numeric(algae_events$decimalLatitude),digits = 4)
algae_events$decimalLongitude<-abs(round(as.numeric(algae_events$decimalLongitude),digits = 4))*-1

class(algae_events$coordinateUncertaintyInMeters) #good
class(algae_events$maximumDepthInMeters) #some missing. ask Melinda to fill this in
class(algae_events$minimumDepthInMeters)#some missing. ask Diane to fill this in
class(algae_events$recordedBy) #some missing. ask Diane to fill this in
class(algae_events$samplingProtocol) #some missing. ask Diane to fill this in
class(algae_events$`habitat: biotic`)
class(algae_events$`habitat: geomorphological zone`)
class(algae_events$`habitat: substrate`)


#Recommended fields
class(algae_events$eventRemarks)
class(algae_events$locality)
class(algae_events$eventTime)
class(algae_events$eventRemarks)
class(algae_events$verbatimCoordinates)
class(algae_events$eventMedia)
```

### Format samples to schema

```{r format samples}

class(algae_samples$occurrenceID)
algae_samples$basisOfRecord<-"specimen"
class(algae_samples$eventID)
class(algae_samples$scientificName) #eventually parse this into taxon categories?
class(algae_samples$taxonRank) #using this
class(algae_samples$identifiedBy)
class(algae_samples$individualCount)
algae_samples$institutionID<-"USNM"



```




### join the event data onto the occurrence data

```{ join}
algae<-left_join(algae_samples,algae_events,by="eventID")
```

## Make A Map
```{r algae_maps}


#by individual
algae2<-algae %>% group_by(decimalLatitude, decimalLongitude) %>% summarize(count=n()) 

#by species
algae3 <- algae[-which(algae$scientificName=="?"),] %>% group_by(scientificName, decimalLatitude, decimalLongitude) %>% summarize(count=n())

#richness
algae4<-algae3 %>% group_by(decimalLatitude,decimalLongitude) %>% summarize(richness=n())

algae5<-left_join(algae2,algae4)

algae5<-algae5[-which(is.na(algae5$decimalLatitude)),]
#algae5<-algae5[-which(algae5$scientificName=="?"),]

algae5[4,4]<-1
algae5[11,4]<-2
extra<-algae5[33,]
algae5<-algae5[-33,] #remove outlier


ggmap(dmap) + geom_point(data = algae5, mapping = aes(x = decimalLongitude, y = decimalLatitude, size=count, color=richness)) + scale_color_gradient(low = "green", high="red") + guides(color=guide_colorbar(title="Type Richness",), size=guide_legend(title="Individual Count")) + theme(axis.title=element_blank()) + geom_point(data=extra, mapping=aes(x = decimalLongitude, y = decimalLatitude, size=30, color=30))

#ggsave(alMAP,filename="algae_map2.pdf"")
```


## Inverts
```{r inverts}
invert_station<-read_excel(path="./inverts/inverts_events.xlsx", sheet = "Station")

invertmap<-ggmap(dmap) + geom_point(data = invert_station, mapping = aes(x = decimalLongitude, y = decimalLatitude), color="orange")
