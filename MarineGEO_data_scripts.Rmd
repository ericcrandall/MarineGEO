---
title: "MarineGEO Data Formatting"
author: "Eric D. Crandall"
date: "5/29/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(plyr)
library(dplyr)
library(ggmap)
library(readxl)
library(lubridate)
filedir<-"~/google_drive/MarineGEO"

bbox<-c(left=-157.85,bottom= 21.38,right=-157.75, top=21.55)
dmap <- get_map(location = bbox, maptype = "satellite", source = "google")

```

# Fish

## Import and Format

### Import
```{r Fish_import}
# First go through and make sure all stations have Lat/Longs, or as many as possible
#read in the sample data, skipping first 3 lines of other headers. Format all times as hh:mm in Excel, paste into textwrangler if they need homogenization (i.e. multiple formats of times)

fish_samples<-read_excel(path="/Users/eric/google_drive/MarineGEO/Fish/KANEOHOE_SI_FIMS_20170714.xlsx",sheet="Specimen information",skip=3)

fish_events<-read_excel(path="/Users/eric/google_drive/MarineGEO/Fish/KANEOHOE_SI_FIMS_20170714.xlsx",sheet="Locality information",skip=3)

#remove columns without mapped DwC terms mapped
fish_samples<-fish_samples[,-grep(pattern = "^X",x = names(fish_samples),perl=T)]
fish_events<-fish_events[,-grep(pattern = "^X",x = names(fish_events),perl=T)]

#remove records without occurrenceIDs (temp before final dataset)
fish_samples<-fish_samples[-which(is.na(fish_samples$occurrenceID)),]
#translate fieldIDs to eventIDs
fish_samples$eventID<-gsub("LRP 17-","KANF0",fish_samples$eventID)

#use ddply to lump all materialSampleIDs into a single field, separated by a |
fish_samples<-ddply(fish_samples, "occurrenceID", transform, materialSampleID = paste(materialSampleID, collapse = "|"))

#keep only the first instance of each occurrenceID
fish_samples<-fish_samples1[!duplicated(fish_samples1$occurrenceID),]
```

### Format events to schema

```{r format events}
fish_events$decimalLatitude<-round(as.numeric(fish_events$decimalLatitude),digits = 4)
fish_events$decimalLongitude<-round(as.numeric(fish_events$decimalLongitude),digits = 4)
fish_events$georeferenceProtocol[which(fish_events$georeferenceProtocol=="GoogleEarth")]<-"Google Earth" ##Ask Diane to fill this in.
class(fish_events$coordinateUncertaintyInMeters) # ask Diane to fill this in.
fish_events$eventDate<-dmy(fish_events$eventDate) # make sure this imports correctly
class(fish_events$maximumDepthInMeters) #some missing. ask Diane to fill this in
class(fish_events$minimumDepthInMeters)#some missing. ask Diane to fill this in
class(fish_events$recordedBy) #some missing. ask Diane to fill this in
class(fish_events$samplingProtocol) #some missing. ask Diane to fill this in
class(fish_events$habitatGeomorphologicalZone) #needs to be formatted according to schema - Geomorph zone, substrate, biotic
fish_events$year<-year(fish_events$eventDate)
fish_events$month<-month(fish_events$eventDate)
fish_events$day<-day(fish_events$eventDate)

#Recommended fields
class(fish_events$eventRemarks)
class(fish_events$locality)
class(fish_events$eventTime)
class(fish_events$eventRemarks)
class(fish_events$eventRemarks)
class(fish_events$verbatimCoordinates)
class(fish_events$eventMedia)
```
### Format samples to schema

```{r format samples}

class(fish_samples$occurrenceID)
class(fish_samples$basisOfRecord)
class(fish_samples$eventID)
class(fish_samples$scientificName) #eventually parse this into taxon categories?
class(fish_samples$taxonRank) #using this
class(fish_samples$identifiedBy)
class(fish_samples$individualCount)
class(fish_samples$institutionID)
fish_samples$organismScope<-"organism"


```

### Join the event data onto the occurrence data

```{r}
fish<-left_join(fish_samples1,fish_events,by="eventID")
```

## Make a Map

```{r Fish_maps}
#optionally make it from the points provided
#bbox<-make_bbox(lon=fish2$decimalLongitude,lat=fish2$decimalLatitude)
#by individual
fish2<-fish %>% group_by(decimalLatitude, decimalLongitude) %>% summarize(count=n()) 

#by species
fish3 <- fish %>% group_by(scientificName, decimalLatitude, decimalLongitude) %>% summarize(count=n())

#richness
fish4<-fish3 %>% group_by(decimalLatitude,decimalLongitude) %>% summarize(richness=n())

fish6<-left_join(fish2,fish4)


ggmap(dmap) + geom_point(data = fish6, mapping = aes(x = decimalLongitude, y = decimalLatitude, size=count, color=richness)) + scale_color_gradient(low = "green", high="red") + guides(color=guide_colorbar(title="Species Richness",), size=guide_legend(title="Individual Count")) + theme(axis.title=element_blank())




```
# Algae

## Import and Format

### Import
```{r Algae_import}
#Add in KANI and KANM stations to events, edit eventIDs for capitalization

algae_samples<-read_excel("/Users/eric/google_drive/MarineGEO/algae/MarineGEOHI_bioassessment_master_KANA.xlsx", sheet="Sample")

algae_events<-read_excel("/Users/eric/google_drive/MarineGEO/algae/MarineGEOHI_bioassessment_master_KANA.xlsx", sheet="Station")
```

### Format events to schema

```{r Format events}
#round to 4 decimal digits (~10m uncertainty) and meake sure longitude is negative
algae_events$decimalLatitude<-round(as.numeric(algae_events$decimalLatitude),digits = 4)
algae_events$decimalLongitude<-abs(round(as.numeric(algae_events$decimalLongitude),digits = 4))*-1

class(algae_events$geoReferenceProtocol) #good
class(algae_events$coordinateUncertaintyInMeters) #good
class(algae_events$maximumDepthInMeters) #some missing. ask Melinda to fill this in
class(algae_events$minimumDepthInMeters)#some missing. ask Melinda to fill this in
class(algae_events$recordedBy) #some missing. ask Melinda to fill this in
class(algae_events$samplingProtocol) #some missing. ask Melinda to fill this in
class(algae_events$`habitatBiotic`)
class(algae_events$`habitatGeomorphologicalZone`)
class(algae_events$`habitatSubstrate`)


#Recommended fields
class(algae_events$eventRemarks)
class(algae_events$locality)
class(algae_events$eventTime)
class(algae_events$eventRemarks)
class(algae_events$verbatimCoordinates)
class(algae_events$eventMedia)
```

### Format samples to schema

```{r format samples}

class(algae_samples$occurrenceID)
algae_samples$basisOfRecord<-"specimen"
class(algae_samples$eventID)
class(algae_samples$scientificName) #eventually parse this into taxon categories?
class(algae_samples$taxonRank) #using this
class(algae_samples$identifiedBy)
class(algae_samples$individualCount)
algae_samples$institutionID<-"USNM"



```




### join the event data onto the occurrence data

```{ join}
algae<-left_join(algae_samples,algae_events,by="eventID")
```

## Make A Map
```{r algae_maps}


#by individual
algae2<-algae %>% group_by(decimalLatitude, decimalLongitude) %>% summarize(count=n()) 

#by species
algae3 <- algae[-which(algae$scientificName=="?"),] %>% group_by(scientificName, decimalLatitude, decimalLongitude) %>% summarize(count=n())

#richness
algae4<-algae3 %>% group_by(decimalLatitude,decimalLongitude) %>% summarize(richness=n())

algae5<-left_join(algae2,algae4)

algae5<-algae5[-which(is.na(algae5$decimalLatitude)),]
#algae5<-algae5[-which(algae5$scientificName=="?"),]

algae5[4,4]<-1
algae5[11,4]<-2
extra<-algae5[33,]
algae5<-algae5[-33,] #remove outlier


almap<-ggmap(dmap) + geom_point(data = algae5, mapping = aes(x = decimalLongitude, y = decimalLatitude, size=count, color=richness)) + scale_color_gradient(low = "green", high="red") + guides(color=guide_colorbar(title="Type Richness",), size=guide_legend(title="Individual Count")) + theme(axis.title=element_blank()) + geom_point(data=extra, mapping=aes(x = decimalLongitude, y = decimalLatitude, size=30, color=30))

almap

#ggsave(almap,filename="algae_map2.pdf")
```


# Macroinvertebrates

## Import and Format

### Import
```{r inverts}
invert_events<-read_excel(path="/Users/eric/google_drive/MarineGEO/Inverts/BKANE_063017_FIMS.xlsx", sheet = "Station", skip=2)

invert_samples<-read_excel(path="/Users/eric/google_drive/MarineGEO/Inverts/BKANE_063017_FIMS.xlsx", sheet = "Specimen",skip=3)

#remove columns that don't appear in MarineGEO schema
invert_samples<-invert_samples[,-grep(pattern = "^X",x = names(invert_samples),perl=T)]
invert_events<-invert_events[,-grep(pattern = "^X",x = names(invert_events),perl=T)]

#remove records without occurrenceIDs (temp before final dataset)
invert_samples<-invert_samples[-which(is.na(invert_samples$scientificName)),]



```

### Taxonomize

This code will populate `taxonRank` with the lowest known taxonomic category

```{r Taxonomize}

invert_samples$taxonRank[which(!is.na(invert_samples$Phylum))]<-"Phylum"
invert_samples$taxonRank[which(!is.na(invert_samples$Class))]<-"Class"
invert_samples$taxonRank[which(!is.na(invert_samples$Subclass))]<-"Subclass"
invert_samples$taxonRank[which(!is.na(invert_samples$Order))]<-"Order"
invert_samples$taxonRank[which(!is.na(invert_samples$Suborder))]<-"Suborder"
invert_samples$taxonRank[which(!is.na(invert_samples$Superfamily))]<-"Superfamily"
invert_samples$taxonRank[which(!is.na(invert_samples$Family))]<-"Family"
invert_samples$taxonRank[which(!is.na(invert_samples$Subfamily))]<-"Subfamily"
invert_samples$taxonRank[which(!is.na(invert_samples$Genus))]<-"Genus"
invert_samples$taxonRank[which(!is.na(invert_samples$Species))]<-"Species"
invert_samples$taxonRank[grep("sp\\.",invert_samples$Species)]<-"Genus"


```

### Format events to schema

```{r format events}
#round to 4 decimal digits (~10m uncertainty) and meake sure longitude is negative
invert_events$decimalLatitude<-round(as.numeric(invert_events$decimalLatitude),digits = 4)
invert_events$decimalLongitude<-abs(round(as.numeric(invert_events$decimalLongitude),digits = 4))*-1

invert_events$geoReferenceProtocol<-"GPS"
invert_events$coordinateUncertaintyInMeters<-50
class(invert_events$maximumDepthInMeters) #some missing. ask John to fill this in
class(invert_events$minimumDepthInMeters)#some missing. ask John to fill this in
class(invert_events$recordedBy) #good
class(invert_events$samplingProtocol) #some missing. ask John to fill this in
invert_events$habitatBiotic<-NA
class(invert_events$habitatGeomorphologicalZone) #some missing. ask John to fill this in
class(invert_events$habitatSubstrate) # some missing. ask John to fill this in


#Recommended fields
invert_events$eventRemarks<-NA
class(invert_events$locality)
invert_events$eventTime<-NA
class(invert_events$eventRemarks)
invert_events$verbatimCoordinates<-NA
invert_events$eventMedia<-NA

```
### Format samples to schema

```{r format samples}

class(invert_samples$occurrenceID)
invert_samples$basisOfRecord<-"specimen"
invert_samples$eventID<-gsub(pattern="(\\w) or \\w",replacement="\\1",x= invert_samples$eventID,perl=T) #  remove the or, pick the first one, still need to fix a few weird ones down the road
class(invert_samples$scientificName) #eventually parse this into taxon categories?
class(invert_samples$taxonRank) #using this
invert_samples$identifiedBy<-"Paulay, Gustav"
class(invert_samples$individualCount)
invert_samples$institutionID<-"FLMNH"



```

### Join the event data onto the occurrence data

```{r}
invert<-left_join(invert_samples,invert_events,by="eventID")
```

## Make A Map
```{r algae_maps}
#by individual
invert2<-invert %>% group_by(decimalLatitude, decimalLongitude) %>% summarize(individualCount=sum(individualCount,na.rm = T)) 

#by species
invert3 <- invert %>% group_by(scientificName, decimalLatitude, decimalLongitude) %>% summarize(count=n())

#richness
invert4<-invert3 %>% group_by(decimalLatitude,decimalLongitude) %>% summarize(richness=n())

invert5<-left_join(invert2,invert4)




invertmap<-ggmap(dmap) + geom_point(data = invert5[-c(61,62),], mapping = aes(x = decimalLongitude, y = decimalLatitude, size=individualCount, color=richness)) + scale_color_gradient(low = "green", high="red") + guides(color=guide_colorbar(title="Type Richness",), size=guide_legend(title="Individual Count")) + theme(axis.title=element_blank()) 

invertmap

#ggsave(almap,filename="invert_map2.pdf")
```

# Meiofauna

## Import and Format

### Import
```{r import}
meio_events<-read_excel(path="/Users/eric/google_drive/MarineGEO/Meiofauna/Hawaii2017_meiofauna_MarineGEO.xlsx", sheet = "station data", skip=1)

meio_samples<-read_excel(path="/Users/eric/google_drive/MarineGEO/Meiofauna/Hawaii2017_meiofauna_MarineGEO.xlsx", sheet = "specimen data",skip=2)

#remove columns that don't appear in MarineGEO schema
meio_samples<-meio_samples[,-grep(pattern = "^X",x = names(meio_samples),perl=T)]
meio_events<-meio_events[,-grep(pattern = "^X",x = names(meio_events),perl=T)]

#add occurrence IDs to one investigators samples
meio_samples$occurrenceID[which(is.na(meio_samples$occurrenceID))]<-"UJ" 

#make occurrence IDs unique
meio_samples$occurrenceID<-make.unique(meio_samples$occurrenceID, sep="_")


```

### Format events to schema

```{r format events}
#round to 4 decimal digits (~10m uncertainty) and meake sure longitude is negative
meio_events$decimalLatitude<-round(as.numeric(meio_events$decimalLatitude),digits = 4)
meio_events$decimalLongitude<-abs(round(as.numeric(meio_events$decimalLongitude),digits = 4))*-1

meio_events$coordinateUncertaintyInMeters<-50
class(meio_events$maximumDepthInMeters)
class(meio_events$minimumDepthInMeters)
class(meio_events$recordedBy) #ask Freya to follow format
class(meio_events$samplingProtocol) #some missing. ask Freya to fill this in
class(meio_events$habitatGeomorphologicalZone) #some missing. ask Freya to fill this in
class(meio_events$habitatSubstrate) # some missing. ask Freya to fill this in


#Recommended fields
meio_events$eventRemarks<-NA
class(meio_events$locality)
meio_events$eventDate<-ymd(meio_events$eventDate,tz="HST")
meio_events$eventTime<-as.character(parse_date_time(meio_events$eventTime, orders="ymdHMS", tz="HST"),format="%H:%M")
class(meio_events$eventRemarks)
meio_events$verbatimCoordinates<-NA
meio_events$eventMedia<-"N"

```
### Format samples to schema

```{r format samples}

class(meio_samples$occurrenceID)
class(meio_samples$eventID)
class(meio_samples$scientificName) #eventually parse this into taxon categories?
class(meio_samples$taxonRank) #using this
class(meio_samples$identifiedBy)
class(meio_samples$individualCount)
meio_samples$institutionID<-"USNM"



```

### Join the event data onto the occurrence data

```{r}
meio<-left_join(meio_samples,meio_events,by="eventID")
```

## Make A Map
```{r algae_maps}
#by individual
meio2<-meio %>% group_by(decimalLatitude, decimalLongitude) %>% summarize(individualCount=sum(individualCount,na.rm = T)) 

#by species
meio3 <- meio %>% group_by(scientificName, decimalLatitude, decimalLongitude) %>% summarize(count=n())

#richness
meio4<-meio3 %>% group_by(decimalLatitude,decimalLongitude) %>% summarize(richness=n())

meio5<-left_join(meio2,meio4)




meiomap<-ggmap(dmap) + geom_point(data = meio5, mapping = aes(x = decimalLongitude, y = decimalLatitude, size=individualCount, color=richness)) + scale_color_gradient(low = "green", high="red") + guides(color=guide_colorbar(title="Type Richness",), size=guide_legend(title="Individual Count")) + theme(axis.title=element_blank()) 

meiomap

#ggsave(almap,filename="meio_map2.pdf")
```
